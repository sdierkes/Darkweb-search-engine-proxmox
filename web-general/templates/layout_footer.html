<!--============================= FOOTER =============================-->
<footer class="main-block dark-bg">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="copyright">
                    <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                    <p><a href="https://www.nexvisionlab.com">NEXVISIONLAB.</a> All right reserved.</p>
                    <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                </div>
            </div>
        </div>
    </div>
</footer>
<!--//END FOOTER -->


<!-- jQuery, Bootstrap JS. -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="/static/js/jquery-3.2.1.min.js"></script>
<script src="/static/js/popper.min.js"></script>
<script src="/static/js/bootstrap.min.js"></script>

<!-- MDBootstrap Datatables  -->
<link href="/static/css/datatables.min.css" rel="stylesheet">
<!-- MDBootstrap Datatables  -->
<script type="text/javascript" src="/static/js/datatables.min.js"></script>

<script type="text/javascript" src="/static/js/allinone.js"></script>

<script>
    $(window).scroll(function () {
        // 100 = The point you would like to fade the nav in.

        if ($(window).scrollTop() > 100) {

            $('.fixed').addClass('is-sticky');

        } else {

            $('.fixed').removeClass('is-sticky');

        }
        ;
    });
    $(document).ready(function () {

        $('#dt-material-checkbox').dataTable({
            columnDefs: [{
                orderable: false,
                className: 'select-checkbox',
                targets: 0
            }],
            select: {
                style: 'os',
                selector: 'td:first-child'
            },
            searching: false
        });

        var client = elasticsearch.Client({
            host: window.location.hostname+':9200'
        });
        var query = {
            "bool": {
                "must": [
                    {
                        "query_string": {
                            "query": $('#input_search').val(),
                            "fields": [
                                "title",
                                "title_raw",
                                "url",
                                "body_stripped",
                                "body_stripped_raw"
                            ]
                        }
                    },
                    {
                        "term": {
                            "type": "darknet"
                        }
                    }
                ]
            }
        };

	// Make sure you initialize with .DataTable (1.10 API), not .dataTable (1.9)
	var table = $('#searchlist').DataTable({
	  serverSide: true,
	  processing: true,
	  searching: false,
	  ordering: false,
	  pageLength: 25,
	  deferRender: true,

	  // Talk to Elasticsearch directly and return the 1.10 "data" shape
	  ajax: function (data, callback, settings) {
	    var from = data.start || 0;
	    var size = data.length || 25;

	    client.search({
	      index: 'hiddenservices',
	      body: {
	        from: from,
	        size: size,
	        query: query,
	        _source: ['domain', 'title', 'visited_at'],
	        sort: [{ 'visited_at': { order: 'desc' } }]
	      }
	    }).then(function (resp) {
	      var hits = (resp.hits && resp.hits.hits) || [];

	      // Flatten each hit to a simple object that matches your columns
	      var rows = hits.map(function (h) {
	        var s = h._source || {};
	        return {
	          domain: s.domain || '',
	          title: s.title || '',
	          visited_at: s.visited_at || ''
	        };
	      });

	      // ES 6/7+: total is an object { value, relation }; ES 5: number
	      var total = 0;
	      if (resp.hits && resp.hits.total != null) {
	        total = typeof resp.hits.total === 'object' ? resp.hits.total.value : resp.hits.total;
	      }

	      callback({
	        draw: data.draw,
	        recordsTotal: total,
	        recordsFiltered: total,
	        data: rows
	      });
	    }).catch(function (err) {
	      console.error('ES search failed:', err);
	      callback({ draw: data.draw, recordsTotal: 0, recordsFiltered: 0, data: [] });
	    });
	  },

	  columns: [
	    {
	      title: 'Domain',
	      data: 'domain',
	      defaultContent: '',
	      render: function (data, type) {
	        if (type !== 'display' || !data) return data;
	        var url = /^https?:\/\//i.test(data) ? data : ('http://' + data);
	        var text = String(data)
	          .replace(/&/g, '&amp;')
	          .replace(/</g, '&lt;')
	          .replace(/>/g, '&gt;');
	        return '<a href="' + url + '" target="_blank" rel="noopener noreferrer">' + text + '</a>';
	      }
	    },
	    { title: 'Title', data: 'title', defaultContent: '' },
	    {
	      title: 'Updated',
	      data: 'visited_at',
	      defaultContent: '',
	      render: function (data, type) {
	        if (!data || type !== 'display') return data;
	        try { return new Date(data).toLocaleString(); } catch { return data; }
	      }
	    }
	  ]
	});

	// Optional: surface any DataTables errors to the console
	$('#searchlist').on('error.dt', function (e, settings, techNote, message) {
	  console.warn('DataTables error:', message);
	});


    });
</script>
</body>

</html>
